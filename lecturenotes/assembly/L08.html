
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>8. SLS Lecture 8 : Writing some simple assembly programs &#8212; UndertheCovers</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. UC-SLS Lecture 9 : Assembly : Operations and Data Types" href="L09.html" />
    <link rel="prev" title="7. SLS Lecture 7 : Assembly Programming Introduction" href="L07.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">UndertheCovers</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro_ln.html">
   Under the Covers : The Secret Life of Software
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course Specfic Introductions
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../L00_210_JA.html">
   CS210 Computer Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../L00_400_F21_JA.html">
   CS400 Fall 2021 : Machine Level Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The Unix Development Environment
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../unix/L01.html">
   1. SLS: Part I - UNIX : Introduction &amp;  Preliminaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../unix/L02.html">
   2. SLS Lecture 2 : Shell Part II : Programming, Files and Directories
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../unix/L03.html">
   3. SLS Lecture 3 : I/O, Process Control and Credentials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../unix/L04.html">
   4. SLS Lecture 4 : Editors, Make and Terminal IDEs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../unix/L05.html">
   5. SLS Lecture 5 : Version Control and GIT: The Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../unix/L06.html">
   6. SLS Lecture 6 : Versions Control and GIT :  Beyond the Basics
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The Belly of the Beast: The von Neumann Architecture and Assembly Programming
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L07.html">
   7. SLS Lecture 7 : Assembly Programming Introduction
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   8. SLS Lecture 8 :  Writing some simple assembly programs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L09.html">
   9. UC-SLS Lecture 9 : Assembly : Operations and Data Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L10.html">
   10. SLS Lecture 10 : Assembly : Program Anatomy I
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L11.html">
   11. SLS Lecture 11 :  Program Anatomy II : Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L12.html">
   12. SLS Lecture 12 : Program Anatomy III : Code as Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L13.html">
   13. SLS Lecture 13 : Program Anatomy V: The Tree of Bytes and Data Structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L14.html">
   14. SLS Lecture 14 : Assembly using the OS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L15.html">
   15. SLS Lecture 15 : Topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L16.html">
   16. SLS Lecture 16 : Topics
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Into the Light : C Programming
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L17.html">
   17. UC-SLS Lecuture 17 : In to the Light - C Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L18.html">
   18. UC-SLS Lecture 18 : Using C to write and organize opcode bytes - Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L19.html">
   19. UC-SLS Lecture 19 : Using C to map and organize our data bytes - Data Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L20.html">
   20. UC-SLS Lecture 20 : Using LibC to access the OS and escape the confines our our process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L21.html">
   21. UC-SLS Lecture 21 : The rest of LibC and other libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L22.html">
   22. SLS Lecture 22 : Topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L23.html">
   23. SLS Lecture 23 : Topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L24.html">
   24. SLS Lecture 24 : Topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../C/L25.html">
   25. SLS Lecture 25 : Topics
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/assembly/L08.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jappavoo/UndertheCovers"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        <a class="jupyterhub-button" href="https://jupyterhub-opf-jupyterhub.apps.smaug.na.operate-first.cloud/hub/user-redirect/git-pull?repo=https://github.com/jappavoo/UndertheCovers&urlpath=tree/UndertheCovers/underthecovers/assembly/L08.ipynb&branch=main"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-a-popcnt-assembly-program">
   8.1. Writing a
   <code class="docutils literal notranslate">
    <span class="pre">
     popcnt
    </span>
   </code>
   assembly program
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-an-add-assembly-program">
   8.2. Writing an
   <code class="docutils literal notranslate">
    <span class="pre">
     add
    </span>
   </code>
   assembly program
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ending-exiting-our-program-process">
   8.3. Ending / Exiting our Program/Process
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-can-we-avoid-this">
     8.3.1. How can we avoid this
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interrupt-3-int3-trap-to-debugger">
     8.3.2. Interrupt 3
     <code class="docutils literal notranslate">
      <span class="pre">
       int3
      </span>
     </code>
     – trap to debugger
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exit-an-os-service-to-terminate-a-process">
     8.3.3. Exit – An OS service to terminate a process
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-os-system-calls">
     8.3.4. The OS System Calls
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#here-is-a-fully-documented-fancy-version">
       8.3.4.1. Here is a fully documented fancy version
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="sls-lecture-8-writing-some-simple-assembly-programs">
<h1><span class="section-number">8. </span>SLS Lecture 8 :  Writing some simple assembly programs<a class="headerlink" href="#sls-lecture-8-writing-some-simple-assembly-programs" title="Permalink to this headline">¶</a></h1>
<p>Spend some time writing some very simple assembly programs and learn to use the debugger so that we have enough skills to explore how things work.    We will be repeat various things in more detail in future lectures.</p>
<ul class="simple">
<li><p>Write <code class="docutils literal notranslate"><span class="pre">popcnt</span></code> in assemble code</p>
<ul>
<li><p>use gdb to play with the popcnt program</p></li>
</ul>
</li>
<li><p>Write a simple <code class="docutils literal notranslate"><span class="pre">add</span></code> in assembly code</p>
<ul>
<li><p>use gdb to play with the add program</p>
<ul>
<li><p>using the cpu as a glorified calculator</p>
<ul>
<li><p>first pass at CPU support for “numbers”</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>What happens if we let our programs continue</p>
<ul>
<li><p>how do we successfully “halt/end” our execution</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">int3</span></code> trap</p>
<ul>
<li><p>tells OS to return control to debugger</p></li>
</ul>
</li>
<li><p>more generally how can we make a Kernel/System Call</p></li>
</ul>
</li>
<li><p>revisit <code class="docutils literal notranslate"><span class="pre">add</span></code> programs adding exits</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">int3</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exit</span></code> syscall</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Implicitly use our shell, editor, Make and Git knowledge to do the above</p></li>
</ul>
<div class="section" id="writing-a-popcnt-assembly-program">
<h2><span class="section-number">8.1. </span>Writing a <code class="docutils literal notranslate"><span class="pre">popcnt</span></code> assembly program<a class="headerlink" href="#writing-a-popcnt-assembly-program" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Write a one instruction assembly program</p>
<ol class="simple">
<li><p>first using .byte</p></li>
<li><p>using intel assembly instruction</p></li>
</ol>
</li>
<li><p>Use gdb to explore how this instruction works</p>
<ul>
<li><p>learn to use gdb to set register values</p></li>
<li><p>and how to execute and re-execute an instruction</p></li>
</ul>
</li>
</ul>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<p><b>CODE: asm - The 'popcnt' assembly program</p>
<div style="width:107em; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>	<span class="na">.intel_syntax</span> <span class="no">noprefix</span>
	
	<span class="na">.text</span>
        
	<span class="na">.global</span> <span class="no">_start</span> 	
<span class="no">_start</span><span class="p">:</span>
	<span class="nf">popcnt</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>   <span class="c1">// same as  .byte 0xF3, 0x48, 0x0F, 0xB8, 0xD8  </span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<p>Here is a fully commented version of the same code.</p>
<p><b>CODE: asm - The commented 'popcnt' assembly program</p>
<div style="width:107em; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span><span class="cm">/*  General antomy of a assembly program line</span>
<span class="cm">[lablel]:   &lt;directive or opcode&gt; [operands]  // comment</span>
<span class="cm">*/</span>
	<span class="na">.intel_syntax</span> <span class="no">noprefix</span>   <span class="c1"># assembler syntax to use &lt;directive&gt;</span>
	                         <span class="c1"># set assembly language format to intel  </span>

	<span class="na">.text</span>                    <span class="c1"># linker section &lt;directive&gt;</span>
	                         <span class="c1"># let the linker know that what follows are cpu instructions to</span>
	                         <span class="c1"># to be executed -- uposed to values that represent data.</span>
	                         <span class="c1"># For historical reasons cpu instructions are called &quot;text&quot;</span>
	                         
	<span class="na">.global</span> <span class="no">_start</span>           <span class="c1"># linker symbol type &lt;directive&gt; </span>
	                         <span class="c1"># makes the symbol _start in this case visible to the linker</span>
	                         <span class="c1"># The linker looks for an _start symbol so that it knows address</span>
	                         <span class="c1"># of the first instruction of our program</span>
	
<span class="nl">_start:</span>                          <span class="c1"># introduce a symbolic (human readable) label for &quot;this&quot; address</span>
	                         <span class="c1"># associates the address of this point in our program with the</span>
      	                         <span class="c1"># name following the &#39;:&#39; -- in our case _start</span>
	                         <span class="c1"># In our program or in the debugger we can use this name to</span>
	                         <span class="c1"># to refer to this location -- address.  And thus the values</span>
	                         <span class="c1"># that end up here.</span>
<span class="c1">#	.byte 0xF3, 0x48, 0x0F, 0xB8, 0xD8  # popcnt rax,rbx	</span>
	<span class="nf">popcnt</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>          <span class="c1"># ok the single intel opcode (instruction) that makes up</span>
	                         <span class="c1"># our program</span>
<span class="cm">/*</span>
<span class="cm">     Details about the assembler directives and general syntax that we will be using</span>
<span class="cm">     https://sourceware.org/binutils/docs/as/</span>
<span class="cm">     Intel instruction set reference -- documents the cpu memonics/instructions of</span>
<span class="cm">                                    the computer&#39;s processor that we are writing for</span>
<span class="cm">	 https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-combined-volumes-2a-2b-2c-and-2d-instruction-set-reference-a-z.html</span>
<span class="cm">*/</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.byte</span></code> directive to set the values in memory to anything we like
eg.</p>
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>     <span class="na">.byte</span> <span class="mi">0xF3</span><span class="p">,</span> <span class="mi">0x48</span><span class="p">,</span> <span class="mi">0x0F</span><span class="p">,</span> <span class="mi">0xB8</span><span class="p">,</span> <span class="mi">0xD8</span>  
</pre></div>
</div>
<p>But of course the real value is that we could have also simply written</p>
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>       <span class="nf">popcnt</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>          
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">#To assemble and link the code we will use the following command:</span>
gcc --static -g -nostartfiles -nostdlib -Wl,--build-id<span class="o">=</span>none -Wa,-alh -Xlinker -Map<span class="o">=</span>popcnt.map popcnt.S -o popcnt &gt; popcnt.lst
<span class="c1"># We can automate this using a makefile so that all we would need to do is:</span>
make popcnt
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># To get the debugger going:</span>
  gdb -tui popcnt
<span class="c1"># Now we want use gdb command to poke around popcnt</span>
<span class="c1"># To setup the assembly syntax to intel: </span>
  <span class="nb">set</span> disassembly-flavor intel
<span class="c1"># Configure a layout that is more friendly to assembly code:</span>
  tui new-layout mylayout regs <span class="m">3</span> <span class="o">{</span>src <span class="m">1</span> asm <span class="m">1</span><span class="o">}</span> <span class="m">2</span> cmd <span class="m">1</span> status <span class="m">0</span>
<span class="c1"># Switch to the new layout:   </span>
  layout mylayout
<span class="c1"># force small command window to be sure lots of room for regs</span>
  winh cmd <span class="m">4</span>
<span class="c1"># make command window in focus so that arrows work as history  </span>
  focus cmd
  
<span class="c1"># Set a breakpoint at the start symbol so exection will stop their: </span>
  <span class="nb">break</span> _start
<span class="c1"># Start the program running:</span>
  run
<span class="c1"># play around with popcnt</span>

<span class="nb">set</span> <span class="nv">rbx</span> <span class="o">=</span> 0b11
<span class="nb">set</span> <span class="nv">rbx</span> <span class="o">=</span> 0xFFFE
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="writing-an-add-assembly-program">
<h2><span class="section-number">8.2. </span>Writing an <code class="docutils literal notranslate"><span class="pre">add</span></code> assembly program<a class="headerlink" href="#writing-an-add-assembly-program" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>re-enforce the steps to creating and debugging an assembly program</p>
<ul>
<li><p>begin to explore CPU support for working with “numbers”</p>
<ul>
<li><p>cpu as a calculator</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>Lets work with the <code class="docutils literal notranslate"><span class="pre">add</span></code> instruction in a similar way that we did with <code class="docutils literal notranslate"><span class="pre">popcnt</span></code></p></li>
<li><p>explore the results of adding with binary, hex, unsigned and signed values</p></li>
<li><p>explore overflow</p></li>
<li><p>then make the program a little more complex:</p></li>
</ul>
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>  <span class="nf">movabs</span> <span class="no">rbx</span><span class="p">,</span> <span class="mi">0xdeadbeefdeadbeef</span>
  <span class="nf">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>
  <span class="nf">add</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>
</pre></div>
</div>
<ul class="simple">
<li><p>lets use some more cool features of the intel instruction set</p></li>
</ul>
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>  <span class="nf">rdrand</span> <span class="no">rbx</span>                
  <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>
  <span class="nf">add</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>
  <span class="nf">popcnt</span> <span class="no">rbx</span><span class="p">,</span> <span class="no">rax</span>
</pre></div>
</div>
<ul class="simple">
<li><p>lets get a brief glimpse at how to use memory locations for the value</p></li>
</ul>
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>        <span class="na">.intel_syntax</span> <span class="no">noprefix</span>
        <span class="na">.data</span>
<span class="nl">x:</span>       <span class="na">.quad</span> <span class="mi">142</span>
<span class="nl">y:</span>       <span class="na">.quad</span> <span class="mi">4200</span>
<span class="nl">sum:</span>     <span class="na">.quad</span>

        <span class="na">.text</span>
        <span class="na">.global</span> <span class="no">_start</span>
<span class="nl">_start:</span>
        <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="no">QWORD</span> <span class="no">PTR</span> <span class="no">x</span>
        <span class="nf">add</span> <span class="no">rax</span><span class="p">,</span> <span class="no">QWORD</span> <span class="no">PTR</span> <span class="no">y</span>
        <span class="nf">mov</span> <span class="no">QWORD</span> <span class="no">PTR</span> <span class="no">sum</span><span class="p">,</span> <span class="no">rax</span>
        <span class="nf">int3</span>
</pre></div>
</div>
<ul class="simple">
<li><p>try replacing add with <code class="docutils literal notranslate"><span class="pre">imul</span></code>, <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, <code class="docutils literal notranslate"><span class="pre">xor</span></code></p></li>
</ul>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>	<span class="na">.intel_syntax</span> <span class="no">noprefix</span>

	<span class="na">.text</span> 	
	<span class="no">.global</span> <span class="no">_start</span>
<span class="nl">_start:</span>
	<span class="nf">add</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gcc --static -g -nostartfiles -nostdlib -Wl,--build-id<span class="o">=</span>none -Wa,-alh -Xlinker -Map<span class="o">=</span>add.map add.S -o add &gt; add.lst
<span class="c1"># create makefile that automates</span>
make add
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gdb -tui add
<span class="nb">set</span> disassembly-flavor intel
tui new-layout mylayout regs <span class="m">3</span> <span class="o">{</span>src <span class="m">1</span> asm <span class="m">1</span><span class="o">}</span> <span class="m">2</span> cmd <span class="m">1</span> status <span class="m">0</span>
layout mylayout
winh cmd <span class="m">4</span>
focus cmd
<span class="nb">break</span> _start
run
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="ending-exiting-our-program-process">
<h2><span class="section-number">8.3. </span>Ending / Exiting our Program/Process<a class="headerlink" href="#ending-exiting-our-program-process" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>What happens if we run our programs outside of the debugger?</p>
<ul>
<li><p>why does this happen?</p></li>
</ul>
</li>
</ul>
<div class="section" id="how-can-we-avoid-this">
<h3><span class="section-number">8.3.1. </span>How can we avoid this<a class="headerlink" href="#how-can-we-avoid-this" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>TRAP: Use an instruction that tells the OS to</p>
<ul class="simple">
<li><p>stop the process and give control back to the debuggger</p></li>
<li><p>if no debugger is running just kill process and signal shell</p>
<ul>
<li><p>Instruction: <code class="docutils literal notranslate"><span class="pre">int3</span></code>:</p></li>
<li><p>Opcode: <code class="docutils literal notranslate"><span class="pre">0xCC</span></code></p></li>
<li><p>Description: <code class="docutils literal notranslate"><span class="pre">Interrupt</span> <span class="pre">3</span> <span class="pre">—</span> <span class="pre">trap</span> <span class="pre">to</span> <span class="pre">debugger</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Call OS Kernel Exit Process call</p>
<ul class="simple">
<li><p>This is an example of calling an OS Kernel call to have the kernel do something for your process</p></li>
<li><p>We will look at this more but for the moment here is what is necessary to call <code class="docutils literal notranslate"><span class="pre">exit</span></code></p>
<ul>
<li><p>pass return value to Kernel</p></li>
<li><p>exit/terminate process</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="interrupt-3-int3-trap-to-debugger">
<h3><span class="section-number">8.3.2. </span>Interrupt 3 <code class="docutils literal notranslate"><span class="pre">int3</span></code> – trap to debugger<a class="headerlink" href="#interrupt-3-int3-trap-to-debugger" title="Permalink to this headline">¶</a></h3>
<img alt="../_images/int3mp.png" src="../_images/int3mp.png" />
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>	<span class="na">.intel_syntax</span> <span class="no">noprefix</span>

	<span class="na">.text</span> 	
	<span class="no">.global</span> <span class="no">_start</span>
<span class="nl">_start:</span>
	<span class="nf">int3</span>
	
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="exit-an-os-service-to-terminate-a-process">
<h3><span class="section-number">8.3.3. </span>Exit – An OS service to terminate a process<a class="headerlink" href="#exit-an-os-service-to-terminate-a-process" title="Permalink to this headline">¶</a></h3>
<p>To exit your process and return an exit value</p>
<ul class="simple">
<li><p>requires a call to the OS!</p></li>
</ul>
<p>On Intel the instruction is <code class="docutils literal notranslate"><span class="pre">syscall</span></code></p>
<img alt="../_images/syscallmp.png" src="../_images/syscallmp.png" />
</div>
<div class="section" id="the-os-system-calls">
<h3><span class="section-number">8.3.4. </span>The OS System Calls<a class="headerlink" href="#the-os-system-calls" title="Permalink to this headline">¶</a></h3>
<p>Each OS Kernel provides a set of calls that an a process can invoke using the <code class="docutils literal notranslate"><span class="pre">syscall</span></code> instruction on an Intel based computer</p>
<p>The Linux Kernel supports a very large number of system calls each is identified by a unique number that must be placed in <code class="docutils literal notranslate"><span class="pre">RAX</span></code> prior to executing the <code class="docutils literal notranslate"><span class="pre">syscall</span></code> instruction.  Additional arguments are passed in by setting other registers.</p>
<p>With each version of the Kernel the table of calls changes.  Here is one site that provides a list</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">IFrame</span><span class="p">(</span><span class="s2">&quot;https://filippo.io/linux-syscall-table/&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<iframe
    width="100%"
    height="600"
    src="https://filippo.io/linux-syscall-table/"
    frameborder="0"
    allowfullscreen
></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>From the above we can see that the <code class="docutils literal notranslate"><span class="pre">exit</span></code> system call number is <code class="docutils literal notranslate"><span class="pre">60</span></code></p></li>
<li><p>reading some man pages <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">syscall</span></code> and <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">syscalls</span></code> we find that</p>
<ul>
<li><p>we must place <code class="docutils literal notranslate"><span class="pre">60</span></code> in <code class="docutils literal notranslate"><span class="pre">rax</span></code></p></li>
<li><p>and that the value we want to return in <code class="docutils literal notranslate"><span class="pre">rdi</span></code></p></li>
</ul>
</li>
</ul>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div style="width:100%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>	<span class="na">.intel_syntax</span> <span class="no">noprefix</span>
	
	<span class="na">.text</span>
	<span class="na">.global</span> <span class="no">_start</span>
<span class="nl">_start:</span>      	
	<span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="mi">60</span>    <span class="c1"># Linux exit system call number is 60       </span>
	<span class="nf">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>     <span class="c1"># rdi is return value 0 success</span>

	<span class="nf">syscall</span>                         	
</pre></div>
</div>
</div>
</div>
</div>
<p>Operating system code usually provides files that you can include in your code so that you don’t have to hardcode magic numbers like <code class="docutils literal notranslate"><span class="pre">60</span></code> for exit.  In Linux you can add the following file <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;asm/unistd_64.h&gt;</span></code> to get all the system call numbers.  You can then use <code class="docutils literal notranslate"><span class="pre">__NR_exit</span></code> to mean the number for the exit system call.</p>
<p>eg.</p>
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>    <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span><span class="no">__NR_exit</span> <span class="c1"># exit system call number</span>
    <span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span><span class="mi">0</span>         <span class="c1"># UNIX success value is 0</span>
    <span class="nf">syscall</span>           <span class="c1"># call OS. This will not return</span>
</pre></div>
</div>
<div class="section" id="here-is-a-fully-documented-fancy-version">
<h4><span class="section-number">8.3.4.1. </span>Here is a fully documented fancy version<a class="headerlink" href="#here-is-a-fully-documented-fancy-version" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<p>A commented version that avoids &quot;magic&quot; numbers.</p>
<div style="width:200%; height:100%; font-size:inherit; overflow: auto;" >
<div class="highlight-gas notranslate"><div class="highlight"><pre><span></span>	<span class="c1"># Pull in a file that contains all the OS system call numbers</span>
	<span class="c1"># for this to work we must preprocess this file via gcc -E before</span>
	<span class="c1"># we can assemble it with as so that the contents of the header file</span>
	<span class="c1"># will be included </span>
	
<span class="c1">#include &lt;asm/unistd_64.h&gt;</span>

	<span class="c1"># See discussion bellow to understand what is in this file</span>
	
	<span class="na">.intel_syntax</span> <span class="no">noprefix</span>   <span class="c1"># set assembly language format to intel</span>

	<span class="c1"># Define some constants so that we don&#39;t have magic numbers</span>
	<span class="c1"># in our code.  We use the .equ (equal) assembly directive</span>
	<span class="c1"># &quot;This directive sets the value of symbol to expression.&quot;</span>
	<span class="c1"># (https:#sourceware.org/binutils/docs/as/Equ.html#Equ)</span>
	<span class="c1"># FORMAT:	</span>
	<span class="c1"># .equ &lt;SYMBOL&gt;, &lt;EXPRESSION&gt;</span>
	
	<span class="na">.equ</span> <span class="no">UNIX_SUCCESS_VALUE</span><span class="p">,</span> <span class="mi">0</span>      
	<span class="no">.equ</span> <span class="no">LINUX_SYSCALL_EXIT</span><span class="p">,</span> <span class="no">__NR_exit</span>

	<span class="na">.text</span>                    <span class="c1"># Place the following in the area that</span>
	                         <span class="c1"># instruction should be encoded and stored</span>
	                         <span class="c1"># for historical reasons it is called text</span>
	<span class="na">.global</span> <span class="no">_start</span>
<span class="nl">_start:</span>                          <span class="c1"># The linker knows to mark the _start address</span>
                              	 <span class="c1"># as location where execution should begin.</span>
	                         <span class="c1"># The OS will be sure to setup the CPU so that the</span>
	                         <span class="c1"># program counter is initialized with this address</span>

	<span class="c1"># To voluntarily hand control of the cpu back to the Operating system so it can</span>
	<span class="c1"># do somthing for us we use a special instruction</span>
	<span class="c1">#  -- on x86_64 this instruction is syscall (man syscall - table 1)</span>
	<span class="c1">#</span>
	<span class="c1"># Operating systems provide many functions that a program can call to</span>
	<span class="c1"># get things done.  eg.  open a stream, read or write bytes to or from a stream</span>
	<span class="c1"># or simply terminate and exit our program.</span>
	<span class="c1">#</span>
	<span class="c1"># Each call is identifed by a number we call a system call number.</span>
	<span class="c1"># On LINUX it expects us to load rax register with the system call number</span>
	<span class="c1"># prior to executing the syscall.  Once control is handed over to the OS</span>
	<span class="c1"># It will then look the number up and invoke the approriate function inside itself.</span>
	<span class="c1"># Other registers can be used to pass parmeters to the particular OS system call function</span>
	<span class="c1"># that we want to invoke.  The following is the conventions on X86_64 Linux</span>
	<span class="c1"># </span>
	<span class="c1">#       Arch/ABI      arg1  arg2  arg3  arg4  arg5  arg6  arg7 </span>
        <span class="c1"># ────────────────────────────────────────────────────────────</span>
        <span class="c1">#       x86-64        rdi   rsi   rdx   r10   r8    r9    -</span>
	<span class="c1"># (see man syscall -- table 2)</span>
	<span class="c1"># The list of all Linux system call numbers can be found in a file so that programers</span>
	<span class="c1"># can know what number to use to invoke a particular call</span>
	<span class="c1"># On our installation of linux you can find it here</span>
	<span class="c1">#  /usr/include/x86_64-linux-gnu/asm/unistd_64.h</span>
	<span class="c1"># For an explanation of all the systems calls see man syscalls (note the s)</span>
	<span class="c1"># -- When we switch to understanding C we it will be easier to understand</span>
	<span class="c1">#    the above manual pages</span>
	<span class="c1">#</span>
	<span class="c1"># On LINUX </span>
	<span class="c1">#   One of these calls is the EXIT system call that tells OS our program is done </span>
	<span class="c1">#   (see man 2 exit)</span>
	
	<span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">LINUX_SYSCALL_EXIT</span>        <span class="c1"># load rax with the Linux system call number for</span>
	                                       <span class="c1"># exit</span>
	
	<span class="nf">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="no">UNIX_SUCCESS_VALUE</span>        <span class="c1"># load rdi with the exit status value we want</span>
	                                       <span class="c1"># to pass back to the program that launched us</span>
	                                       <span class="c1"># eg. the shell in which we ran our program from</span>
	
	<span class="nf">syscall</span>                                <span class="c1"># use the syscall instruction to hand control over</span>
	                                       <span class="c1"># to the OS.  Note since we will be terminated</span>
	                                       <span class="c1"># this instruction will be our last and nothing else</span>
	                                       <span class="c1"># need follow it</span>
	
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./assembly"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="L07.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">7. </span>SLS Lecture 7 : Assembly Programming Introduction</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="L09.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">9. </span>UC-SLS Lecture 9 : Assembly : Operations and Data Types</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Jonathan Appavoo<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>